/*!
CMSFileBrowser v.1.0
(C) 2019-2022 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL3+
*/
function CMSFileBrowser(e){var t,n,i,a,r,o,l,s,d,c;function f(e){u(e=$.extend({},d||{},e||{}))}function u(e){d=top.document.CMSFileBrowser?$.extend({},top.document.CMSFileBrowser.settings,e||{}):e||{},t=d.target||null,n=$("#fp-progress"),i=$("#fp-progress-text"),a=$("#fp-dropzone"),o=$("#btn-file"),l=$("#fp-file-upload"),s=$("#fp-list"),r=null,function(){if($("#fp-type-filter").length<1)return;var e=s.find(".fpitem").not(".header,.dir");$("#fp-type-filter .js-trigger").on("click activate",function(t){var n=$(this),i=n.attr("data-fb-type");"RESET"===i||n.hasClass("active")?e.show(150):e.hide(50).filter("div."+i).show(100),$("#fp-type-filter .js-trigger").removeClass("active"),n.addClass("active")})}(),d.type&&"ANY"!==d.type?$('#fp-type-filter [data-fb-type="'+d.type+'"]').trigger("click"):$('#fp-type-filter [data-fb-type="RESET"]').addClass("active");var f=0;$(window).on("close",function(){0!=f&&clearInterval(f)}).on("resize",function(){var e=!0;0===f&&(f=setInterval(function(){e?e=!1:(clearInterval(f),f=0),window.innerWidth<380?a.css("width","3em"):a.css("width","9em")},250))}).trigger("resize"),setTimeout(function(){s.find("a.js-trigger-insert").on("click activate",function(e){e.preventDefault();var n=$(this),i=n.attr("href"),a=d.inst||$("html").data("cmsfp-inst");if(d&&d.onselect)return d.onselect(a,i),!1;if(t)t instanceof $||(t=$(t));else{var r='[data-cmsfp-instance="'+a+'"]';t=parent.$(r)||$(r)}return t.length>0&&(t.is(":input")&&t.val(i).trigger("change"),t.trigger("cmsfp:change",i)),!1}),$("#level-up").on("click activate",function(e){e.preventDefault();var t=$(this).attr("data-chdir");window.location.href=d.list_url+"&cwd="+d.cwd+"&"+t}),$(".filepicker-cmd").on("click activate",function(e){var t=$(this).attr("data-cmd");switch(t){case"del":!function(e){e.preventDefault();var t=e.target.closest(".fpitem"),n=$(t).data("fb-fname");cms_confirm(d.lang.confirm_delete,"",cms_lang("yes"),cms_lang("no")).done(function(){var e=m("del",n);$.ajax(e).done(function(){window.location.reload(!0)}).fail(function(e,t,n){console.debug("FileBrowser deletion failed: "+n),cms_alert(d.lang.error_failed_ajax+": "+n)})})}(e);break;case"mkdir":!function(e){e.preventDefault(),cms_dialog($("#mkdir_dlg"),{modal:!0,buttons:[{text:d.lang.ok,click:function(){var e=$("#fld_mkdir").val().trim(),t=m("mkdir",e);$.ajax(t).done(function(){window.location.reload(!0)}).fail(function(e,t,n){console.debug("FileBrowser mkdir failed: "+n),cms_alert(d.lang.error_failed_ajax+": "+n)}),cms_dialog($(this),"close")}},{text:d.lang.cancel,click:function(){cms_dialog($(this),"close")}}]})}(e)}}),function(){var e=l.attr("name"),t={url:d.cmd_url,dataType:"json",extraData:{cmd:"upload",val:"",cwd:d.cwd,inst:d.inst,filefield:e},fieldName:e,inputFile:l[0],allowedTypes:d.mime||"*",extFilter:d.extensions||null,onBegin:function(){cms_busy(),c=[],a.length>0&&a.addClass("visuallyhidden"),i.show(),r=$("<div/>",{id:"fp-progress-inner"}),n.prepend(r).show(),o.addClass("disabled").css("pointer-events","none")},onComplete:function(){p(!0)},onBeforeUpload:function(e){i.text(""),r.width(0)},onUploadProgress:function(e,t){r.animate({width:t+"%"},200,function(){$(this).attr("aria-valuenow",t),i.text(t+"%")})},onUploadCanceled:function(e){p(!0)},onUploadError:function(e,t,n,i){t.responseJSON?c.push(t.responseJSON.message):c.push(i)},onFileTypeError:function(e){c.push(v("error_type",e.data.name||"File"))},onFileExtError:function(e){c.push(v("error_ext",e.data.name||"File"))},onFileSizeError:function(e){c.push(v("error_size",e.data.name||"File"))}};if(l.dmUploader(t),a.length>0){t.extraData.filefield="dropzone",t.fieldName="dropzone",t.inputFile=null,t.hookDocument=!1,a.dmUploader(t);var s=!1;a.on("dragenter dragover",function(e){$(this).addClass("dragging"),s=!0}).on("dragleave",function(e){$(this).removeClass("dragging"),s=!1}).on("mouseup",function(e){$(this).removeClass("dragging"),s&&(s=!1)})}}()},250)}function p(e){if(c.length>0){var t=d.lang.error_title+":\n&nbsp;"+c.join("\n&nbsp;");cms_alert(t,"",!0).always(function(){a.length>0&&a.removeClass("visuallyhidden"),o.removeClass("disabled").css("pointer-events","inherit"),g(e)})}else setTimeout(function(){a.length>0&&a.removeClass("visuallyhidden"),o.removeClass("disabled").css("pointer-events","inherit"),g(e)},2e3)}function g(e){cms_busy(!1),e?window.location.reload(!0):(n.hide().remove("#fp-progress-inner"),r=null,i.hide().text(""),a.length>0&&a.removeClass("visuallyhidden"),l.blur())}function m(e,t){return{method:"POST",url:d.cmd_url,data:{cmd:e,val:t,cwd:d.cwd,inst:d.inst}}}function v(e,t){return void 0!==d.lang[e]?void 0===t?d.lang[e]:d.lang[e].replace("%s",t):"Missing translation for "+e}void 0!==e?f(e):u({}),this.settings=d,this.set_options=f}
