tinymce.PluginManager.add("cmsms_linker",function(e,t){function n(){var t,n,a,s,l,i,m,c,r,o,u,_,p,g={},f=e.selection,h=e.dom;function y(e){$(".ui-autocomplete").css("z-index",7e4),$(".ui-helper-hidden-accessible").hide();var t=document.getElementById(e);$(t).autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term},success:function(e){t(e)}})},focus:function(e,t){e.preventDefault()},select:function(e,n){$(t).val(n.item.label),$(".mce-cmsms-linker-alias").val(n.item.value),$(".mce-cmsms-linker-href").val("{cms_selflink href='"+n.item.value+"'}"),e.preventDefault()}})}t=f.getNode(),n=h.getParent(t,"a[href]"),g.page="",g.alias="",g.text=a=n?n.innerText||n.textContent:f.getContent({format:"text"}),g.href=n?h.getAttrib(n,"href"):"",g.target=n?h.getAttrib(n,"target"):"",g.classname=n?h.getAttrib(n,"class"):"",g.rel=n?h.getAttrib(n,"rel"):"",-1!==g.href.indexOf("cms_selflink")&&(u=g.href.match(/href=(.*)[\s\}]/)).length>=2&&(g.alias=u[1].replace(/'/g,""),g.page=cmsms_tiny.loading_info,$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:g.alias},success:function(e){g.page=e.label,g.href="{cms_selflink href='"+g.alias+"'}",$(".mce-cmsms-linker-page").val(g.page),$(".mce-cmsms-linker-alias").val(g.alias),$(".mce-cmsms-linker-href").val(g.href)}})),"IMG"===t.nodeName&&(g.text=a=" "),!1!==e.settings.target_list&&(c={name:"target",type:"listbox",label:cmsms_tiny.prompt_target,values:(_=g.target,p=[{text:cmsms_tiny.target_none,value:""}],e.settings.target_list||p.push({text:cmsms_tiny.target_new_window,value:"_blank"}),tinymce.each(e.settings.target_list,function(e){p.push({text:e.text||e.title,value:e.value,selected:_===e.value})}),p)}),l={name:"page",type:"textbox",size:40,classes:"cmsms-linker-page",tooltip:cmsms_tiny.prompt_page_info,label:cmsms_tiny.prompt_page,onkeyup:function(){y(this._id)},onchange:function(){y(this._id)}},i={name:"alias",disabled:!0,type:"textbox",size:40,label:cmsms_tiny.prompt_alias,tooltip:cmsms_tiny.prompt_alias_info,classes:"cmsms-linker-alias"},m={name:"text",type:"textbox",size:40,label:cmsms_tiny.prompt_text,onchange:function(){g.text=this.value()},onkeyup:function(){g.text=this.value()}},r={name:"classname",type:"textbox",size:40,label:cmsms_tiny.prompt_class,onchange:function(){g.classname=this.value()},onkeyup:function(){g.classname=this.value()}},o={name:"rel",type:"textbox",size:40,label:cmsms_tiny.prompt_rel,onchange:function(){g.rel=this.value()},onkeyup:function(){g.rel=this.value()}},s=e.windowManager.open({title:cmsms_tiny.linker_text,data:g,bodyType:"tabpanel",body:[{title:cmsms_tiny.tab_general,type:"form",items:[l,i,m,{name:"href",type:"textbox",classes:"cmsms-linker-href",size:100,hidden:!0,value:"{cms_selflink href='"+g.alias+"'}"}]},{title:cmsms_tiny.tab_advanced,type:"form",items:[c,r,o]}],onSubmit:function(){var t=s.toJSON(),l=t.href,i=t.page;l&&i?t.text!==a?n?(e.focus(),n.innerHTML=t.text,h.setAttribs(n,{href:l,target:t.target?t.target:null,rel:t.rel?t.rel:null,class:t.classname?t.classname:null}),f.select(n)):e.insertContent(h.createHTML("a",{href:l,target:t.target?t.target:null,rel:t.rel?t.rel:null,class:t.classname?t.classname:null},t.text)):e.execCommand("mceInsertLink",!1,{href:l,target:t.target,rel:t.rel?t.rel:null,class:t.classname?t.classname:null}):e.execCommand("unlink")}})}e.addButton("cmsms_linker",{title:cmsms_tiny.linker_title,icon:"link",image:cmsms_tiny.linker_image,onclick:n,stateSelector:"a[href]"}),e.addMenuItem("cmsms_linker",{text:cmsms_tiny.linker_text,title:cmsms_tiny.linker_title,image:cmsms_tiny.linker_image,stateSelector:"a[href]",context:"insert",prependToContext:!0,onclick:n})});