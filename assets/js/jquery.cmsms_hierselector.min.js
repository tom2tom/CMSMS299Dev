/*!
jQuery hierselector widget v.1.1
(C) 2014-2019 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL2+
*/
!function($){$.widget("cmsms.hierselector",{options:{current:0,selected:0,is_manager:!1,allow_current:!0,use_perms:!1,use_simple:!1,allow_all:!1,for_child:!1},_create:function(){this.data={},this.data.orig_val=this.element.val(),this.data.name=this.element.attr("name"),this.data.id=this.element.attr("id");var e=this,t={op:"pageinfo",page:this.data.orig_val};return t[cms_data.secure_param_name]=cms_data.user_key,$.ajax(cms_data.ajax_hiersel_url,{data:t,dataType:"json"}).fail(function(e,t,a){console.debug("selector creation failed: "+a)}).done(function(t){if("success"===t.status){var a=t.data;e.data.orig_val=a.content_id,e.data.orig_idhier=a.id_hierarchy;try{e.data.orig_pages=a.id_hierarchy.split(".")}catch(t){e.data.orig_pages=[a.id_hierarchy]}e.element.hide().val("").removeAttr("name").attr("readonly","readonly"),e.data.hidden_e=$('<input type="hidden" name="'+e.data.name+'" value="'+e.data.orig_val+'" />').insertAfter(e.element),e._setup_dropdowns()}else console.debug("selector creation failed: "+t.message)})},_setOption:function(e,t){this.options[e]=t,this._setup_dropdowns()},_setup_dropdowns:function(){this.options.use_simple?this._setup_simple_dropdown():this._setup_smart_dropdowns()},_build_simple_select:function(e,t,a,s){var i=cms_lang("hierselect_title"),n=$("<select></select>").attr({id:e,title:i}).addClass("cms_selhier");n.on("change",function(){var e=$(this),t=e.val();e.trigger("cmsms_formchange",{elem:e,value:t})});for(var o=0;o<t.length;o++){var r;try{r=t[o].hierarchy.split(".").length}catch(e){r=1}i="&nbsp;&nbsp;".repeat(r-1)+t[o].display;var d=$("<option>"+i+"</option>").attr("value",t[o].content_id);t[o].content_id==a&&d.attr("selected","selected").addClass("selected"),t[o].content_id==s&&d.addClass("hilite"),t[o].content_id!=this.options.selected||this.options.allow_current||d.attr("disabled","disabled"),this.options.use_perms&&!t[o].can_edit&&d.attr("disabled","disabled").addClass("nochildren"),n.append(d)}return n},_build_smart_select:function(e,t,a,s,n){var o=this,r=cms_lang("hierselect_title");if(sel=$("<select></select>").attr({id:e,title:r}).addClass("cms_selhier"),sel.on("change",function(){var e=$(this),t=e.val();t<1&&void 0===(t=e.prev("select").val())&&(t=-1),o.data.hidden_e.val(t).change(),o._setup_smart_dropdowns(),e.trigger("cmsms_formchange",{elem:e,value:t})}),s){var d=$("<option>"+cms_lang("none")+"</option>").attr("value",-1);sel.append(d)}for(i=0;i<t.length;i++){d=$("<option>"+t[i].display+"</option>").attr("value",t[i].content_id);t[i].content_id==a&&d.attr("selected","selected").addClass("selected"),t[i].content_id==n&&d.addClass("hilite"),t[i].content_id!=this.options.selected||this.options.allow_current||d.attr("disabled","disabled"),(t[i].has_children||!this.options.use_perms||t[i].can_edit)&&(!this.options.for_child||t[i].has_children||t[i].wants_children)||d.attr("disabled","disabled").addClass("nochildren"),sel.append(d)}return sel},_setup_smart_dropdowns:function(){var e=this.data.hidden_e.val(),t={op:"here_up",page:e};for(var a in t[cms_data.secure_param_name]=cms_data.user_key,this.options)this.options.hasOwnProperty(a)&&(t[a]=this.options[a]);var s=this;return $.ajax(cms_data.ajax_hiersel_url,{data:t,dataType:"json"}).fail(function(e,t,a){console.debug("smart dropdown population failed: "+a)}).done(function(t){if("success"===t.status){var a,i=t.data,n="";a=!(s.options.for_child&&s.options.use_perms&&!s.options.is_manager);for(var o=0;o<i.length&&!n;o++)if(i[o])for(var r=0;r<i[o].length&&!n;r++)if(i[o][r].content_id==e){n=i[o][r].id_hierarchy;break}var d=[];if(n)try{d=n.split(".")}catch(e){d=[n]}for(s.element.prevAll("select.cms_selhier").remove(),s.element.val(""),o=0;o<i.length;o++)if(null!=i[o]){var l=o<d.length?d[o]:-1;if(l)for(r=0;r<i[o].length;r++)if(i[o][r].content_id==l){a=!(!s.options.for_child&&!i[o][r].has_usable_link)&&(!(s.options.for_child&&s.options.use_perms&&!s.options.is_manager&&!i[o][r].can_edit)&&i[o][r].wants_children);break}var _=s.data.orig_pages&&o<s.data.orig_pages.length?s.data.orig_pages[o]:-100;s._build_smart_select(s.data.id+"_"+o,i[o],l,a,_).insertBefore(s.element)}}else console.debug("smart dropdown population failed: "+t.message)})},_setup_simple_dropdown:function(){var e=this,t={op:"userpages"};for(var a in t[cms_data.secure_param_name]=cms_data.user_key,this.options)this.options.hasOwnProperty(a)&&(t[a]=this.options[a]);return $.ajax(cms_data.ajax_hiersel_url,{data:t,dataType:"json"}).fail(function(e,t,a){console.debug("simple dropdown population failed: "+a)}).done(function(t){if("success"===t.status){var a=t.data,s=e.data.hidden_e.val();e._build_simple_select(e.data.id+"_0",a,s,!0,-1).insertBefore(e.element)}else console.debug("simple dropdown population failed: "+t.message)})},_noop:function(){}})}(jQuery);
