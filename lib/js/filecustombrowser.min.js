/*!
CMSCustomFileBrowser v.0.8
(C) 2022 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL3+
*/
function CMSCustomFileBrowser(e){var n,t,i,a,r,o,l,s,d,c,f;function p(e){u(e=$.extend({},c||{},e||{}))}function u(e){if(n=(c=e||{}).target||null,(t=c.container||null)&&(t instanceof $||(t=$(t)),t[0].innerHTML)){i=t.find("#fp-progress"),a=t.find("#fp-progress-text"),r=t.find("#fp-dropzone"),l=t.find("#btn-upload"),s=t.find("#fp-file-upload"),d=t.find("#fp-list"),o=null,function(){if(t.find("#fp-type-filter").length<1)return;var e=d.find(".fpitem").not(".header,.dir");t.find("#fp-type-filter .js-trigger").on("click activate",function(n){var t=$(this),i=t.attr("data-fb-type");"RESET"===i||t.hasClass("active")?e.show(150):e.hide(50).filter("div."+i).show(100),$("#fp-type-filter .js-trigger").removeClass("active"),t.addClass("active")})}(),c.type&&"ANY"!==c.type?t.find('#fp-type-filter [data-fb-type="'+c.type+'"]').trigger("click"):t.find('#fp-type-filter [data-fb-type="RESET"]').addClass("active");var f=0;$(window).on("close",function(){0!=f&&clearInterval(f)}).on("resize",function(){var e=!0;0===f&&(f=setInterval(function(){e?e=!1:(clearInterval(f),f=0),window.innerWidth<380?r.css("width","3em"):r.css("width","9em")},250))}).trigger("resize"),setTimeout(function(){g(),y(),m()},250)}}function g(){d.find("a.js-trigger-insert").on("click activate",function(e){e.preventDefault();var i=$(this).attr("href"),a=c.inst||t.data("cmsfp-inst");if(c&&c.onselect)return c.onselect(a,i),!1;if(n)n instanceof $||(n=$(n));else{var r='[data-cmsfp-instance="'+a+'"]';n=$(r)||t.find(r)}return n.length>0&&(n.is(":input")&&n.val(i).trigger("change"),n.trigger("cmsfp:change",i)),!1})}function m(){var e=s.attr("name"),n={url:c.cmd_url,dataType:"json",extraData:{cmd:"upload",val:"",cwd:c.cwd,inst:c.inst,filefield:e},fieldName:e,inputFile:s[0],allowedTypes:c.mime||"*",extFilter:c.extensions||null,onBegin:function(){cms_busy(),f=[],r.length>0&&r.addClass("visuallyhidden"),a.show(),o=$("<div/>",{id:"fp-progress-inner"}),i.prepend(o).show(),l.addClass("disabled").css("pointer-events","none")},onComplete:function(){v(!0)},onBeforeUpload:function(e){a.text(""),o.width(0)},onUploadProgress:function(e,n){o.animate({width:n+"%"},200,function(){$(this).attr("aria-valuenow",n),a.text(n+"%")})},onUploadCanceled:function(e){v(!0)},onUploadError:function(e,n,t,i){n.responseJSON?f.push(n.responseJSON.message):f.push(i)},onFileTypeError:function(e){f.push(x("error_type",e.data.name||"File"))},onFileExtError:function(e){f.push(x("error_ext",e.data.name||"File"))},onFileSizeError:function(e){f.push(x("error_size",e.data.name||"File"))}};if(s.dmUploader(n),r.length>0){n.extraData.filefield="dropzone",n.fieldName="dropzone",n.inputFile=null,n.hookDocument=!1,r.dmUploader(n);var t=!1;r.on("dragenter dragover",function(e){$(this).addClass("dragging"),t=!0}).on("dragleave",function(e){$(this).removeClass("dragging"),t=!1}).on("mouseup",function(e){$(this).removeClass("dragging"),t&&(t=!1)})}}function v(e){if(f.length>0){var n=c.lang.error_title+":\n&nbsp;"+f.join("\n&nbsp;");cms_alert(n,"",!0).always(function(){r.length>0&&r.removeClass("visuallyhidden"),l.removeClass("disabled").css("pointer-events","inherit"),h(e)})}else setTimeout(function(){r.length>0&&r.removeClass("visuallyhidden"),l.removeClass("disabled").css("pointer-events","inherit"),h(e)},2e3)}function h(e){cms_busy(!1),e?w(!1):(i.hide().remove("#fp-progress-inner"),o=null,a.hide().text(""),r.length>0&&r.removeClass("visuallyhidden"),s.blur())}function y(){t.find("#level-up").on("click activate",function(e){e.preventDefault(),w($(this).attr("data-chdir"))}),t.find(".filepicker-dir-action").on("click activate",function(e){e.preventDefault();var n=$(this).attr("href"),t=decodeURIComponent(n.replace(/\+/g," ")),i=t.indexOf("?");w(t.substring(i+1))}),t.find(".filepicker-cmd").on("click activate",function(e){switch(e.preventDefault(),$(this).attr("data-cmd")){case"del":!function(e){e.preventDefault();var n=e.target.closest(".fpitem"),t=$(n).data("fb-fname");cms_confirm(c.lang.confirm_delete,"",cms_lang("yes"),cms_lang("no")).done(function(){var e=_("del",t);$.ajax(e).done(function(){w(!1)}).fail(function(e,n,t){console.debug("FileBrowser deletion failed: "+t),cms_alert(c.lang.error_failed_ajax+": "+t)})})}(e);break;case"mkdir":!function(e){e.preventDefault(),cms_dialog($("#mkdir_dlg"),{modal:!0,buttons:[{text:c.lang.ok,click:function(){var e=$("#fld_mkdir").val().trim(),n=_("mkdir",e);$.ajax(n).done(function(){w(!1)}).fail(function(e,n,t){console.debug("FileBrowser mkdir failed: "+t),cms_alert(c.lang.error_failed_ajax+": "+t)}),cms_dialog($(this),"close")}},{text:c.lang.cancel,click:function(){cms_dialog($(this),"close")}}]})}(e)}})}function _(e,n){return{method:"POST",url:c.cmd_url,data:{cmd:e,val:n,cwd:c.cwd,inst:c.inst}}}function w(f){var p={content:!0,cwd:c.cwd||"",inst:c.inst||"",type:e.type};if(f)for(var u=f.split("&"),v=0;v<u.length;v++){var h=u[v].split("=",2);if(h[0].match(/_enc/))p[h[0].trim()]=h[1].trim()}$.ajax(c.list_url,{method:"POST",cache:!1,dataType:"json",data:p}).done(function(e,f,p){c.cwd=e.cwd,c.inst=e.inst,t.html(e.body),i=t.find("#fp-progress"),a=t.find("#fp-progress-text"),r=t.find("#fp-dropzone"),l=t.find("#btn-upload"),s=t.find("#fp-file-upload"),d=t.find("#fp-list"),o=null,n&&n.attr("data-cmsfp-instance",e.inst),g(),y(),m()}).fail(function(e,n,t){var i='<p style="color:red">'+c.lang.error_failed_ajax+": "+t+"</p>";d.empty().append(i),console.error("File-pick ajax error: "+t)})}function x(e,n){return void 0!==c.lang[e]?void 0===n?c.lang[e]:c.lang[e].replace("%s",n):"Missing translation for "+e}void 0!==e?p(e):u({}),this.settings=c,this.set_options=p,this.refresh=h}
