/*!
jQuery Poller v.0.8
(C) 2019 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL2+
*/
var Poller={handlid:1,heap:[],defaults:{url:null,data:null,interval:60,onetime:!1,insert:!1,element:null,start_handler:null,done_handler:null},internal:{timer:null,focus:1,lastrun:null},get_config:function(e){return this.heap[e]||null},add:function(e){var t=$.extend({},this.defaults,e,this.internal);if(!t.url)throw"An URL must be specified for the poller";if(!t.onetime){var n=t.interval;if(n<1||n>3600)throw"The poller run-interval must be in the range 1 to 3600"}var i=this.handlid++;if(this.heap[i]=t,t.element){$.data(document,"polldata",this);var a=t.element instanceof jQuery?t.element[0]:t.element;document.contains(a)&&$(a).find(":input,a").on("click",function(){for(var e=$.data(document,"polldata"),t=0,n=e.heap.length;t<n;t++){var i=e.get_config(e.heap[t]);i&&e._cycle.call(e,i)}}),$(document).on("focus",function(){pd=$.data(document,"polldata");for(var e=0,t=pd.heap.length;e<t;e++){var n=pd.get_config(pd.heap[e]);n&&n.focus<1&&(n.focus=1,pd._cycle.call(pd,n))}}),$(document).on("blur",function(){pd=$.data(document,"polldata");for(var e=0,t=pd.heap.length;e<t;e++){var n=pd.get_config(pd.heap[e]);n&&1===n.focus&&(n.focus=0,pd._stop.call(pd,n))}})}else t.focus=1;return i},settings:function(e,t){var n=this.get_config(e);if(void 0===typeof t){if(n){var i=Object.assign({},n);x=this.internal.keys;for(var a=0,l=x.length;a<l;a++)delete i[x[a]];return i}return{}}if(t){x=this.internal.keys;for(a=0,l=x.length;a<l;a++)delete t[x[a]];if((n=$.extend(n,t)).onetime)return n.timer&&this._stop(n),this._request(n)}},oneshot:function(e){var t=$.extend({},this.defaults,e,this.internal);return t.onetime=!0,this._request(t)},run:function(e){var t=this.add(e),n=this.get_config(t);return n?(n.onetime||this._cycle(n),this._request(n),t):0},stop:function(e){var t=this.get_config(e);t&&this._stop(t)},_stop:function(e){e.timer&&(clearInterval(e.timer),e.timer=null)},cycle:function(e){var t=this.get_config(e);t&&this._cycle(t)},_cycle:function(e){if(!(e.interval<1)){var t=this;e.timer=setInterval(function(){e.focus&&t._request(e)},1e3*e.interval)}},request:function(e){var t=this.get_config(e);if(t)return this._request(t)},_request:function(e){return e.onetime||(e.lastrun=Date.now()/1e3),"function"==typeof e.start_handler&&e.start_handler(e),cms_busy(),$.ajax(e.url,{data:e.data,cache:!1}).always(function(){cms_busy(!1)}).fail(function(t,n,i){console.debug("ajax call to "+e.url+" failed: "+i)}).done(function(t,n,i){e.insert&&e.element&&(e.element instanceof jQuery?e.element.html(t):$(e.element).html(t)),"function"==typeof e.done_handler&&e.done_handler(t,n,i)})}};