/*!
jQuery Ajax File Uploader Widget V.1.1 <https://github.com/danielm/uploader>
(C) 2013-2020 Daniel Morales <daniel85mg@gmail.com>
License MIT
*/
!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery","document"],t):"undefined"!=typeof exports?module.exports=t(require("jquery"),document):t(window.jQuery,document)}(function($,t){"use strict";var e=0,i=1,n=2,s=3,o=4,r=function(t,i){this.data=t,this.widget=i,this.jqXHR=null,this.status=e;var n=Math.random();this.id=(n+10*n).toString(36)};r.prototype.upload=function(){if(!this.canUpload())return this.widget.queueRunning&&this.status!==i&&this.widget.processQueue(),!1;var t=new FormData;t.append(this.widget.settings.fieldName,this.data);var e=this.widget.settings.extraData;"function"==typeof e&&(e=e.call(this.widget.element[0],this.id)),$.each(e,function(e,i){t.append(e,i)}),this.status=i,this.widget.activeFiles++,"function"==typeof this.widget.settings.onBeforeUpload&&this.widget.settings.onBeforeUpload.call(this.widget.element[0],this.id),this.widget.element.trigger("before.dmul",this.id);var n=this;return this.jqXHR=$.ajax({url:this.widget.settings.url,type:this.widget.settings.method,dataType:this.widget.settings.dataType,data:t,headers:this.widget.settings.headers,cache:!1,timeout:0,contentType:!1,processData:!1,forceSync:!1,xhr:function(){return n.getXhr()}}).done(function(t,e,i){n.onSuccess(t)}).fail(function(t,e,i){n.onError(t,e,i)}).always(function(t,e,i){n.onComplete()}),!0},r.prototype.onSuccess=function(t){this.status=n,"function"==typeof this.widget.settings.onUploadSuccess&&this.widget.settings.onUploadSuccess.call(this.widget.element[0],this.id,t),this.widget.element.trigger("success.dmul",[this.id,t])},r.prototype.onError=function(t,e,i){this.status!==o&&(this.status=s,"function"==typeof this.widget.settings.onUploadError&&this.widget.settings.onUploadError.call(this.widget.element[0],this.id,t,e,i),this.widget.element.trigger("error.dmul",[this.id,t,e,i]))},r.prototype.onComplete=function(){this.widget.activeFiles--,this.status!==o&&("function"==typeof this.widget.settings.onUploadComplete&&this.widget.settings.onUploadComplete.call(this.widget.element[0],this.id),this.widget.element.trigger("complete.dmul",this.id)),this.widget.queueRunning?this.widget.processQueue():this.widget.settings.queue&&0===this.widget.activeFiles&&("function"==typeof this.widget.settings.onComplete&&this.widget.settings.onComplete.call(this.widget.element[0]),this.widget.element.trigger("complete.dmul"))},r.prototype.getXhr=function(){var t=$.ajaxSettings.xhr();if(t.upload){var e=this;t.upload.addEventListener("progress",function(t){var i=0,n=t.loaded||t.position,s=t.total||t.totalSize;t.lengthComputable&&(i=Math.ceil(n/s*100)),"function"==typeof e.widget.settings.onUploadProgress&&e.widget.settings.onUploadProgress.call(e.widget.element[0],e.id,i),e.widget.element.trigger("progress.dmul",[e.id,i])},!1)}return t},r.prototype.cancel=function(t){t=void 0!==t&&t;var n=this.status;return!!(n===i||t&&n===e)&&(this.status=o,"function"==typeof this.widget.settings.onUploadCanceled&&this.widget.settings.onUploadCanceled.call(this.widget.element[0],this.id),this.widget.element.trigger("cancel.dmul",this.id),n===i&&this.jqXHR.abort(),!0)},r.prototype.canUpload=function(){return this.status===e||this.status===s};var l=function(t,e){return this.element=t instanceof $?t:$(t),this.settings=$.extend({},$.fn.dmUploader.defaults,e||{}),this.checkSupport()?(this.init(),this):($.error("Browser not supported by the dmUploader plugin"),"function"==typeof this.settings.onFallbackMode&&this.settings.onFallbackMode.call(this.element[0]),this.element.trigger("fallback.dmul"),!1)};l.prototype.checkSupport=function(){if(void 0===window.FormData)return!1;var t=navigator.userAgent;return!t.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)&&!t.match(/\swv\).+(chrome)\/([\w\.]+)/i)&&!$('<input type="file" />').prop("disabled")},l.prototype.getInput=function(){var t=null;return this.settings.inputFile&&((t=this.settings.inputFile)instanceof $||(t=$(t)),t.is("input[type=file]")||(t=null)),null===t&&(t=this.element.is("input[type=file]")?this.element:this.element.find("input[type=file]")),t},l.prototype.init=function(){this.queue=[],this.queuePos=-1,this.queueRunning=!1,this.activeFiles=0,this.draggingOver=0,this.draggingOverDoc=0;var e=this.getInput();if(e){if(e.prop("multiple",this.settings.multiple),"*"!==this.settings.allowedTypes||this.settings.extFilter){var i="*"!==this.settings.allowedTypes?this.settings.allowedTypes:"";this.settings.extFilter&&(this.settings.extFilter.forEach(function(t){"."===t[0]?i+=","+t:i+=",."+t}),","===i[0]&&(i=i.substring(1))),e.prop("accept",i)}else e.prop("accept","");var n=this;e.on("change",function(t){var e=t.target&&t.target.files;e&&e.length&&(n.addFiles(e),$(this).val(""))})}if(this.settings.dnd){var s=$("<div/>")[0];"draggable"in s||"ondragstart"in s&&"ondrop"in s?this.initDnD():this.settings.dnd=!1}return this.settings.paste&&this.initPaste(),e||this.settings.dnd||this.settings.paste?(this.settings.hookDocument&&this.element[0]==t&&(this.settings.hookDocument=!1),"function"==typeof this.settings.onInit&&this.settings.onInit.call(this.element[0]),this.element.trigger("init.dmul"),this):($.error("Markup error found by the dmUploader plugin"),null)},l.prototype.initDnD=function(){var e=this;function i(t){t.preventDefault(),t.stopPropagation()}this.element[0].addEventListener("drop",function(t){i(t),e.draggingOver>0&&(e.draggingOver=0,"function"==typeof e.settings.onDragLeave&&e.settings.onDragLeave.call(e.element[0]),e.element.trigger("dragleave"));var n,s=t.dataTransfer;s&&s.files&&0!=s.files.length&&(n=e.settings.multiple?s.files:[s.files[0]],e.addFiles(n))},!1),this.element[0].addEventListener("dragenter",function(t){i(t),0===e.draggingOver&&"function"==typeof e.settings.onDragEnter&&e.settings.onDragEnter.call(e.element[0]),e.draggingOver++},!1),this.element[0].addEventListener("dragleave",function(t){i(t),e.draggingOver--,0===e.draggingOver&&"function"==typeof e.settings.onDragLeave&&e.settings.onDragLeave.call(e.element[0])},!1),this.element[0].addEventListener("dragover",i,!1),this.settings.hookDocument&&this.element[0]!=t&&$(t).off("dragenter").on("dragenter.dmul",function(t){i(t),0===e.draggingOverDoc&&("function"==typeof e.settings.onDocumentDragEnter&&e.settings.onDocumentDragEnter.call(e.element[0]),e.element.trigger("docdragenter.dmul")),e.draggingOverDoc++}).off("dragleave").on("dragleave.dmul",function(t){i(t),e.draggingOverDoc--,0===e.draggingOverDoc&&("function"==typeof e.settings.onDocumentDragLeave&&e.settings.onDocumentDragLeave.call(e.element[0]),e.element.trigger("docdragleave.dmul"))}).off("dragover").on("dragover.dmul",function(t){t.preventDefault()}).off("drop").on("drop.dmul",function(t){i(t),e.draggingOverDoc>0&&(e.draggingOverDoc=0,"function"==typeof e.settings.onDocumentDragLeave&&e.settings.onDocumentDragLeave.call(e.element[0]),e.element.trigger("dragleave.dmul"))})},l.prototype.initPaste=function(){var e=this;t.addEventListener("paste",function(t){t.preventDefault();var i,n=t.clipboardData;n&&n.files&&0!=n.files.length&&(i=e.settings.multiple?n.files:[n.files[0]],e.addFiles(i))},!1)},l.prototype.releaseEvents=function(){this.element.off(".dmul");var e=this.getInput();e&&e.off(".dmul"),this.settings.hookDocument&&$(t).off(".dmul")},l.prototype.validateFile=function(t){if(this.settings.maxFileSize>0&&t.size>this.settings.maxFileSize)return"function"==typeof this.settings.onFileSizeError&&this.settings.onFileSizeError.call(this.element[0],t),this.element.trigger("sizeerror.dmul",[t]),!1;if("*"!==this.settings.allowedTypes&&!this.settings.allowedTypes.split(",").some(function(e){return t.type.match(e)}))return"function"==typeof this.settings.onFileTypeError&&this.settings.onFileTypeError.call(this.element[0],t),this.element.trigger("typeerror.dmul",[t]),!1;if(this.settings.extFilter){var e="\\."+this.settings.extFilter.join(".").replace(/\./g,"\\."),i="\\."+t.name.split(".").pop();if(!new RegExp(i,"i").test(e))return"function"==typeof this.settings.onFileExtError&&this.settings.onFileExtError.call(this.element[0],t),this.element.trigger("exterror.dmul",[t]),!1}return new r(t,this)},l.prototype.addFiles=function(t){var e,i,n=0;for(e=0,i=t.length;e<i;e++){var s=this.validateFile(t[e]);if(s){if("function"==typeof this.settings.onNewFile)if(!1===this.settings.onNewFile.call(this.element[0],s.id,s.data))continue;this.settings.auto&&!this.settings.queue&&(0===n&&("function"==typeof this.settings.onBegin&&this.settings.onBegin.call(this.element[0]),this.element.trigger("begin.dmul")),s.upload()),this.queue.push(s),n++}}return 0===n?this:(this.settings.auto&&this.settings.queue&&!this.queueRunning&&("function"==typeof this.settings.onBegin&&this.settings.onBegin.call(this.element[0]),this.element.trigger("begin.dmul"),this.processQueue()),this)},l.prototype.processQueue=function(){return this.queuePos++,this.queuePos>=this.queue.length?(0===this.activeFiles&&("function"==typeof this.settings.onComplete&&this.settings.onComplete.call(this.element[0]),this.element.trigger("complete.dmul")),this.queuePos=this.queue.length-1,this.queueRunning=!1,!1):(this.queueRunning=!0,this.queue[this.queuePos].upload())},l.prototype.restartQueue=function(){this.queuePos=-1,this.queueRunning=!1,this.processQueue()},l.prototype.findById=function(t){var e,i;for(e=0,i=this.queue.length;e<i;e++)if(this.queue[e].id===t)return this.queue[e];return!1},l.prototype.cancelAll=function(){var t,e,i=this.queueRunning;for(this.queueRunning=!1,t=0,e=this.queue.length;t<e;t++)this.queue[t].cancel();i&&("function"==typeof this.settings.onComplete&&this.settings.onComplete.call(this.element[0]),this.element.trigger("complete.dmul"))},l.prototype.startAll=function(){var t,e;if(this.settings.queue)this.restartQueue();else for(t=0,e=this.queue.length;t<e;t++)this.queue[t].upload()},l.prototype.methods={start:function(t){if(this.queueRunning)return!1;var i=!1;return void 0===t||(i=this.findById(t))?i?(i.status===o&&(i.status=e),i.upload()):(this.startAll(),!0):($.error("File not found in the dmUploader plugin"),!1)},cancel:function(t){var e=!1;return void 0===t||(e=this.findById(t))?e?e.cancel(!0):(this.cancelAll(),!0):($.error("File not found in the dmUploader plugin"),!1)},reset:function(){return this.cancelAll(),this.queue=[],this.queuePos=-1,this.activeFiles=0,!0},destroy:function(){this.cancelAll(),this.releaseEvents(),this.element.removeData("dmUploader")}},$.fn.dmUploader=function(t){if("string"!=typeof t)return this.each(function(){$.data(this,"dmUploader")||$.data(this,"dmUploader",new l(this,t))});var e=arguments;this.each(function(){var i=$.data(this,"dmUploader");i instanceof l?"function"==typeof i.methods[t]?i.methods[t].apply(i,Array.prototype.slice.call(e,1)):$.error("Method "+t+" does not exist in the dmUploader plugin"):$.error("Unknown plugin data found by the dmUploader plugin")})},$.fn.dmUploader.defaults=$.extend({},{auto:!0,queue:!0,dnd:!0,paste:!0,hookDocument:!0,multiple:!0,url:t.URL,method:"POST",extraData:{},headers:{},dataType:null,fieldName:"file",maxFileSize:0,allowedTypes:"*",extFilter:null,inputFile:null,onNewFile:null},$.fn.dmUploader.defaults||{})});
