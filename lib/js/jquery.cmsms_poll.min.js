/*!
jQuery Poller v.0.8
(C) 2019-2022 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL3+
*/
var Poller={handlid:1,heap:[],defaults:{url:null,data:null,interval:60,onetime:!1,insert:!1,element:null,start_handler:null,done_handler:null},internal:{timer:null,focus:1,lastrun:null},get_config:function(e){return this.heap[e]||null},add:function(e){var t=$.extend({},this.defaults,e,this.internal);if(!t.url)throw"An URL must be specified for the poller";if(!t.onetime){var n=t.interval;if(n<1||n>3600)throw"The poller run-interval must be in the range 1 to 3600"}var i=this.handlid++;if(this.heap[i]=t,t.element){$.data(document,"polldata",this);var a=t.element instanceof $?t.element[0]:t.element;document.contains(a)&&$(a).find(":input,a").on("click",function(){for(var e=$.data(document,"polldata"),t=0,n=e.heap.length;t<n;t++){var i=e.get_config(e.heap[t]);i&&e._cycle.call(e,i)}}),$(document).on("focus",function(){for(var e=$.data(document,"polldata"),t=0,n=e.heap.length;t<n;t++){var i=e.get_config(e.heap[t]);i&&i.focus<1&&(i.focus=1,e._cycle.call(e,i))}}),$(document).on("blur",function(){for(var e=$.data(document,"polldata"),t=0,n=e.heap.length;t<n;t++){var i=e.get_config(e.heap[t]);i&&1===i.focus&&(i.focus=0,e._stop.call(e,i))}})}else t.focus=1;return i},settings:function(e,t){var n,i,a,l=this.get_config(e);if(void 0===typeof t){if(l){var r=Object.assign({},l);for(i=0,a=(n=this.internal.keys).length;i<a;i++)delete r[n[i]];return r}return{}}if(t){for(i=0,a=(n=this.internal.keys).length;i<a;i++)delete t[n[i]];if((l=$.extend(l,t)).onetime)return l.timer&&this._stop(l),this._request(l)}},oneshot:function(e){var t=$.extend({},this.defaults,e,this.internal);return t.onetime=!0,this._request(t)},run:function(e){var t=this.add(e),n=this.get_config(t);return n?(n.onetime||this._cycle(n),this._request(n),t):0},stop:function(e){var t=this.get_config(e);t&&this._stop(t)},_stop:function(e){e.timer&&(clearInterval(e.timer),e.timer=null)},cycle:function(e){var t=this.get_config(e);t&&this._cycle(t)},_cycle:function(e){if(!(e.interval<1)){var t=this;e.timer=setInterval(function(){e.focus&&t._request(e)},1e3*e.interval)}},request:function(e){var t=this.get_config(e);if(t)return this._request(t)},_request:function(e){return e.onetime||(e.lastrun=Date.now()/1e3),"function"==typeof e.start_handler&&e.start_handler(e),cms_busy(),$.ajax(e.url,{data:e.data,cache:!1}).always(function(){cms_busy(!1)}).fail(function(t,n,i){console.debug("ajax call to "+e.url+" failed: "+i)}).done(function(t,n,i){e.insert&&e.element&&(e.element instanceof $?e.element.html(t):$(e.element).html(t)),"function"==typeof e.done_handler&&e.done_handler(t,n,i)})}};
