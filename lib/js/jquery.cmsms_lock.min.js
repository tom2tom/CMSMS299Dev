/*!
jQuery lockManager widget v.0.2.1
(C) 2014-2022 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL3+
*/
!function($){$.widget("cmsms.lockManager",{options:{touch_handler:null,lostlock_handler:null,error_handler:null,lock_timeout:60,lock_refresh:60},_settings:{locked:0,lock_id:-1,lock_expires:-1},_error_handler:function(t){if("string"==typeof t){var o="error_lock_"+t,e="Unknown Error";void 0!==this._settings.lang[o]&&(e=this._settings.lang[o]),t={type:t,msg:e}}"function"==typeof this.options.error_handler?this.options.error_handler(t):console.debug("Error: "+t.type+" - "+t.msg)},_lostlock_handler:function(t){"function"==typeof this.options.lostlock_handler&&this.options.lostlock_handler(t),console.debug("Error: "+t.type+" - "+t.msg)},_create:function(){if(void 0!==cms_data.admin_url&&(this.options.admin_url=cms_data.admin_url),!this.options.admin_url)throw"The admin_url parameter is not available for the lockManager widget";if(void 0!==cms_data.secure_param_name&&(this.options.secure_param=cms_data.secure_param_name),!this.options.secure_param)throw"The secure_param parameter is not available for the lockManager widget";if(void 0!==cms_data.user_key&&(this.options.user_key=cms_data.user_key),!this.options.user_key)throw"The user_key parameter is not available for the lockManager widget";if(!this.options.type)throw"The lock type option (string) must be set for the lockManager widget";if(!this.options.oid)throw"The object id (oid) option (integer) must be set for the lockManager widget";if(!this.options.uid)throw"The user id (uid) option (string) must be set for the lockManager widget";this.options.lock_refresh=Math.max(this.options.lock_refresh,30),this.options.lock_refresh=Math.min(this.options.lock_refresh,3600);var t=this,o=this.options.admin_url+"/ajax_lock.php",e={opt:"setup",uid:this.options.uid};e[this.options.secure_param]=this.options.user_key,$.ajax(o,{data:e}).always(function(e,s,i){if("success"!==s)throw"Problem communicating with ajax url "+o;"error"===e.status&&t._error_handler(e.error),t._settings=e,t._settings.ajax_url=o,t.options.change_noticed=!1,void 0!==e.uid&&t.options.uid==e.uid?t.options.lock_timeout&&(t._setup_handlers(),t._lock()):t._error_handler("useridmismatch")})},_setup_touch:function(){var t=this,o=t.options.lock_refresh;o=Math.min(3600,Math.max(5,o)),void 0!==t._settings.touch_timer&&clearTimeout(t._settings.touch_timer),t._settings.touch_timer=setTimeout(function(){t._touch()},1e3*o)},_setup_handlers:function(){var t=this;this._settings.touch_skipped=0,this.element.on("change","input:not([type=submit]), select, textarea",function(){t.options.change_noticed=!0,t._settings.touch_skipped&&t._touch()}),this.options.lock_refresh>0&&this._setup_touch()},_touch:function(){var t=this;if(t.options.change_noticed&&t._settings.locked&&t._settings.lock_id>0){console.debug("lockmanager: touching lock"),this._settings.touch_skipped=0;var o={opt:"touch",type:this.options.type,oid:this.options.oid,uid:this.options.uid,lock_id:this._settings.lock_id};o[this.options.secure_param]=this.options.user_key,$.ajax(t._settings.ajax_url,{data:o}).always(function(o,e,s){if("success"!=e)throw"Problem communicating with ajax url "+t._settings.ajax_url;if("error"==o.status)return"cmsnolockexception"==o.error.type?t._lostlock_handler(o.error):t._error_handler(o.error),t._settings.locked=0,t._settings.lock_id=-1,void(t._settings.lock_expires=-1);"function"==typeof t.options.touch_handler&&t.options.touch_handler(),t._settings.lock_expires=o.lock_expires,t.options.change_noticed=!1})}else this._settings.touch_skipped=1;this._setup_touch()},_lock:function(){var t=this;if(!t._settings.locked){var o={opt:"lock",type:this.options.type,oid:this.options.oid,uid:this.options.uid,lifetime:this.options.lock_timeout};o[this.options.secure_param]=this.options.user_key,$.ajax(t._settings.ajax_url,{data:o}).always(function(o,e,s){if("success"!=e)throw"Problem communicating with ajax url "+t._settings.ajax_url;"error"!=o.status?(t.options.lock_handler&&t.options.lock_handler(),t._settings.lock_id=o.lock_id,t._settings.lock_expires=o.lock_expires,t._settings.locked=1):t._error_handler(o.error)})}},relock:function(){this._lock()},unlock:function(t){var o=this;if(o._settings.locked&&o._settings.lock_id>0){var e={opt:"unlock",type:this.options.type,oid:this.options.oid,uid:this.options.uid,lock_id:this._settings.lock_id};if(e[this.options.secure_param]=this.options.user_key,!t&&navigator.sendBeacon){var s=new FormData;for(var i in e)e.hasOwnProperty(i)&&s.append(i,e[i]);if(navigator.sendBeacon(o._settings.ajax_url,s))return o._settings.locked=0,o._settings.lock_id=-1,o._settings.lock_expires=-1,$.Deferred().resolve({status:"success"},"");console.debug("unlock beacon failed... fallback to ajax")}return $.ajax(o._settings.ajax_url,{type:"POST",cache:!1,data:e}).fail(function(t,o,e){console.debug("unlock failed: "+o+" // "+e+" // "+t.status),setTimeout(function(){},3e3)}).done(function(t,e){o.options.unlock_handler&&o.options.unlock_handler(),o._settings.locked=0,o._settings.lock_id=-1,o._settings.lock_expires=-1}).always(function(t,o,e){return 200!=e.status?$.Deferred().reject(t,o):"success"!=o?$.Deferred().reject(t,o):"error"==t.status?$.Deferred().reject(t,o):void 0})}return $.Deferred().resolve({status:"success"},"")},_noop:function(){}})}(jQuery);
